name: Debug Netlify + Repo

on:
  workflow_dispatch:
    inputs:
      umbrella:
        description: "Umbrella site name (Netlify). Leave blank to skip lookup."
        required: false
        default: "golden-elf-b1aa95"

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Print repo tree under sites/
        run: |
          echo "::group::sites tree"
          find sites -maxdepth 2 -type d -print || true
          echo "::endgroup::"

      - name: Show umbrella network.json (from repo)
        run: |
          echo "::group::umbrella repo assets/network.json"
          if [ -f sites/utility-network-landing/assets/network.json ]; then
            cat sites/utility-network-landing/assets/network.json
          else
            echo "no umbrella network.json in repo"
          fi
          echo "::endgroup::"

      - name: Fetch umbrella network.json (LIVE)
        env:
          UMB: ${{ github.event.inputs.umbrella }}
        run: |
          echo "::group::umbrella LIVE assets/network.json"
          if [ -n "$UMB" ]; then
            curl -fsSL "https://${UMB}.netlify.app/assets/network.json" || echo "fetch failed"
          else
            echo "umbrella name not provided"
          fi
          echo "::endgroup::"

      - name: List Netlify sites (needs NETLIFY_TOKEN)
        env:
          NETLIFY_TOKEN: ${{ secrets.NETLIFY_TOKEN }}
        run: |
          set -e
          echo "::group::Netlify sites"
          curl -s -H "Authorization: Bearer $NETLIFY_TOKEN" https://api.netlify.com/api/v1/sites \
            | jq -r '.[] | [.name, .url, .ssl_url] | @tsv' || echo "failed to list sites"
          echo "::endgroup::"

      - name: Check each local site for index.html and sitemap.xml
        run: |
          echo "::group::per-site checks"
          for d in sites/*; do
            [ -d "$d" ] || continue
            echo "# $d"
            test -f "$d/index.html" && echo "  ✓ index.html" || echo "  ✗ index.html missing"
            test -f "$d/sitemap.xml" && echo "  ✓ sitemap.xml" || echo "  ✗ sitemap.xml missing"
            test -f "$d/assets/network-bar.js" && echo "  ✓ network-bar.js" || echo "  ✗ network-bar.js missing"
          done
          echo "::endgroup::"

      - name: Save umbrella index.html and LIVE JSON as artifacts
        if: always()
        run: |
          mkdir -p debug
          cp -f sites/utility-network-landing/index.html debug/umbrella-index.html || true
          curl -fsSL "https://${{ github.event.inputs.umbrella }}.netlify.app/assets/network.json" \
            -o debug/umbrella-network-live.json || true
        shell: bash

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: debug-bundle
          path: debug/*
          if-no-files-found: ignore
