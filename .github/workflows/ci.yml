name: CI (lint + audit)
on:
  pull_request:
  push:
    branches: [ main ]
jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install linters
        run: npm i -g htmlhint
      - name: Generate audit report
        run: |
          node scripts/audit.js || echo "audit script not present in repo; add scripts/audit.js to enable checks"
      - name: Enforce GA4 & AdSense present (soft until audit.js exists)
        run: |
          if [ -f reports-audit.json ]; then
            node -e "const r=require('./reports-audit.json'); const bad=r.filter(x=>!x.gaFound||!x.adsFound||x.missingFiles.length); if(bad.length){console.error('Critical audit failures:', bad); process.exit(1);}"; \
            echo 'Audit OK'
          else
            echo 'reports-audit.json not found; skipping hard enforcement for now';
          fi
      - name: HTML lint (soft fail)
        run: npx htmlhint 'sites/**/*.html' || true
