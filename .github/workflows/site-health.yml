name: Site Health (weekly Lighthouse)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 13 * * 1"   # Mondays 05:00 PT / 13:00 UTC

jobs:
  lighthouse:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install LHCI + jq
        run: |
          npm i -g @lhci/cli@0.13.x
          sudo apt-get update && sudo apt-get install -y jq

      - name: Build URL list (umbrella + live sub-sites)
        id: urls
        run: |
          set -e
          BASE="https://golden-elf-b1aa95.netlify.app"
          curl -fsSL "$BASE/assets/network.json" -o network.json || echo "[]" > network.json
          URLS=("$BASE/")
          mapfile -t EXTRA < <(jq -r '.[].href' network.json 2>/dev/null | sed 's#/*$#/#')
          URLS+=("${EXTRA[@]}")
          printf '%s\n' "${URLS[@]}" | tee urls.txt

      - name: Run Lighthouse CI (desktop, 1 run each)
        run: |
          set -e
          ARGS=""
          while read -r u; do ARGS="$ARGS --collect.url=$u"; done < urls.txt
          lhci autorun \
            --collect.numberOfRuns=1 \
            --collect.settings.preset=desktop \
            $ARGS \
            --upload.target=temporary-public-storage

      - name: Upload HTML reports as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results
          path: .lighthouseci/*
          if-no-files-found: ignore
