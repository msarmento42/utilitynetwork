name: Deploy Utility Network (umbrella + micro-sites)
on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths: [ "sites/**", "scripts/**" ]
permissions:
  contents: write
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install Netlify CLI + jq
        run: npm i -g netlify-cli && sudo apt-get update && sudo apt-get install -y jq
      - name: Deploy everything (manual sites via CLI)
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_TOKEN }}
          GA_ID: ${{ vars.GA_ID || "G-083MSQKPFX" }}
          ADS_PUB: ${{ vars.ADS_PUB || "ca-pub-6175161566333696" }}
          UMBRELLA_SITE_NAME: ${{ vars.UMBRELLA_NAME || "golden-elf-b1aa95" }}
        run: bash -x scripts/deploy-all-with-netlify-cli.sh
      - name: Commit network.json updates (if any)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --cached --quiet || git commit -m "chore: refresh network.json after deploy"
          git push
